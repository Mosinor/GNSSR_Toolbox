from django.shortcuts import render
from django.http import JsonResponse
from django.views.generic import View
from .forms import *
from datetime import timedelta
from .opendap import generate_url, define_dataset_keys, collect_dataset, clock_to_seconds, filter_valid_points_time_specific_level1
from rest_framework.views import APIView
from rest_framework.response import Response
from kladding.realtime_gnssr.loadJSON import collect_sea_levels, collect_sea_roughness, collect_sat_info,\
     raw_measure_info, interferometric_fringe_info
from .data_clipping import collect_level_2_data, collect_level_3_data, collect_level_1_data
from .track_demonstration import collect_level_1_demo_data, collect_level_2_demo_data
from .kladdings import *


def track_demonstration(request):
    error_message = ""
    if request.method == 'POST':
        form = TrackDemoTool(request.POST)
        if form.is_valid():
            coordinate_a = form.cleaned_data['coordinate_a']
            coordinate_b = form.cleaned_data['coordinate_b']
            lats = [float(coordinate_a.split(",")[0]), float(coordinate_b.split(",")[0])]
            lons = [float(coordinate_a.split(",")[1]), float(coordinate_b.split(",")[1])]

            location = [max(lats), min(lons), min(lats), max(lons)]

            date = form.cleaned_data['date']
            start_time = clock_to_seconds(form.cleaned_data['start_time'])
            end_time = clock_to_seconds(form.cleaned_data['end_time'])

            level = form.cleaned_data['level']
            version = form.cleaned_data['version']

            x_axis_selection = form.cleaned_data['x_axis_selection']

            v = ""
            if version == "2":
                v = "v2.1"
            elif version == "3":
                v = "v3.0"

            track_list = []
            graph_selection = []
            if level == "L1":
                y_axis_selection_1 = form.cleaned_data['L1_y_axis_selection_1']
                y_axis_selection_2 = form.cleaned_data['L1_y_axis_selection_2']

                graph_selection = [x_axis_selection, y_axis_selection_1, y_axis_selection_2]

                track_list, url = collect_level_1_demo_data(date, location, start_time, end_time, level, version, graph_selection)

            # Level 2 selection:
            elif level == "L2":
                y_axis_selection_1 = form.cleaned_data['L2_y_axis_selection_1']
                y_axis_selection_2 = form.cleaned_data['L2_y_axis_selection_2']

                graph_selection = [x_axis_selection, y_axis_selection_1, y_axis_selection_2]

                track_list, url = collect_level_2_demo_data(date, location, start_time, end_time, level, version, graph_selection)

            base_url = "https://podaac-opendap.jpl.nasa.gov/opendap/hyrax/allData/cygnss/"+level+"/"+version+"/"+str(date.year) + "/" + str(date.timetuple().tm_yday).zfill(3)

            if any(track_list):
                return render(request, "toolbox/track_demonstration_presentation.html",
                              {'track_list': track_list, 'boundary': location, 'graph_selection': graph_selection, 'data_url':base_url})
            else:
                error_message = "No tracks detected, please try another input."

    else:
        form = TrackDemoTool()

    return render(request, "toolbox/track_demonstration.html", {'form': form, 'error_msg': error_message})


def data_clipping(request):
    if request.method == 'POST':
        form = DataClippingTool(request.POST)
        if form.is_valid():
            coordinate_a = form.cleaned_data['coordinate_a']
            coordinate_b = form.cleaned_data['coordinate_b']
            lats = [float(coordinate_a.split(",")[0]), float(coordinate_b.split(",")[0])]
            lons = [float(coordinate_a.split(",")[1]), float(coordinate_b.split(",")[1])]

            location = [max(lats), min(lons), min(lats), max(lons)]

            start_date = form.cleaned_data['start_date']
            end_date = form.cleaned_data['end_date']

            selected_dates = [start_date + timedelta(days=x) for x in range(0, (end_date.date() - start_date.date()).days)]
            selected_dates.append(end_date)

            level = form.cleaned_data['level']
            version = form.cleaned_data['version']

            v = ""
            if version == "2":
                v = "v2.1"
            elif version == "3":
                v = "v3.0"

            keys = []
            if level == "1":
                keys = form.cleaned_data['keys_level1']
                collect_level_1_data(start_date, end_date, location, "L1", keys, v)

            elif level == "2":
                keys = form.cleaned_data['keys_level2']
                collect_level_2_data(start_date, end_date, location, "L2", keys, v)

            elif level == "3":
                keys = form.cleaned_data['keys_level3']
                collect_level_3_data(start_date, end_date, location, "L3", keys, v)

    else:
        form = DataClippingTool()
    return render(request, "toolbox/data_clipping.html", {'form': form})


class HomeView(View):
    def get(self, request, *args, **kwargs):
        table_data, coordinates, elevation_data = collect_sat_info()


        return render(request, 'toolbox/example.html', {'table_data': table_data, })


def ground_based(request):
    ssl_lables, levels = collect_sea_levels()
    ssr_lables, roughness = collect_sea_roughness()
    table_data, coordinates, skyplot_data = collect_sat_info()
    raw_data = raw_measure_info()
    intf_data = interferometric_fringe_info()

    return render(request, 'toolbox/ground_based_gnssr.html', {
        'ssl_lables': ssl_lables,
        'levels': levels,
        'ssr_lables': ssr_lables,
        'roughness': roughness,
        'skyplot_data': skyplot_data,
        'coordinates': coordinates,
        'raw_data': raw_data,
        'intf_data': intf_data,

    })


def microplastics(request):
    boundary = [35.10193, -27.02637, 30.37288, -19.37988]
    wind_spead_data = load_heat_data()
    nbrcs_data = load_nbrcs_data()
    peak_list = [[30.859664916992188, -24.626556396484375, -9999.0], [31.19322395324707, -23.88214111328125, 172.55596923828125], [31.47429084777832, -23.24530029296875, -9999.0], [31.76461410522461, -22.577880859375, 271.70672607421875], [33.971458435058594, -26.402435302734375, 70.34461975097656], [33.895843505859375, -24.433837890625, 71.1575698852539], [33.77593994140625, -22.3741455078125, 249.17236328125], [35.09489440917969, -23.6258544921875, 100.07451629638672], [35.079345703125, -23.065521240234375, 58.31989669799805], [35.06773376464844, -22.7032470703125, 111.3329849243164], [35.05238723754883, -22.275482177734375, -9999.0], [35.032562255859375, -21.782379150390625, 95.17051696777344], [35.01958465576172, -21.48681640625, -9999.0], [34.991119384765625, -20.89617919921875, -9999.0], [34.94038009643555, -19.979400634765625, -9999.0], [32.753143310546875, -24.577117919921875, 48.201656341552734], [31.45764923095703, -19.718505859375, 43.576454162597656], [33.4816780090332, -26.426544189453125, 71.67440032958984], [33.7115592956543, -25.343170166015625, 56.19924545288086], [34.28740692138672, -22.347381591796875, 200.86187744140625], [34.406314849853516, -21.664764404296875, 181.0933380126953], [34.579524993896484, -20.62054443359375, 149.42587280273438], [33.53002166748047, -24.26129150390625, 47.65877151489258], [33.31306457519531, -19.612457275390625, -9999.0], [35.06956100463867, -23.28790283203125, 45.372528076171875], [34.561492919921875, -21.263641357421875, 36.46915054321289], [34.08133316040039, -19.478363037109375, 33.270599365234375], [33.65397644042969, -26.52520751953125, 36.137664794921875], [33.69932556152344, -24.376495361328125, 56.08110809326172], [33.70178985595703, -22.549530029296875, 40.89777755737305], [33.68586349487305, -21.3740234375, -9999.0], [33.65715026855469, -20.230987548828125, 34.82282257080078], [33.63854217529297, -19.6759033203125, 37.977996826171875], [33.225303649902344, -26.383544921875, 96.26860809326172], [33.22446823120117, -25.284088134765625, 75.70354461669922], [33.15732192993164, -22.208587646484375, 135.75872802734375], [30.403213500976562, -23.5523681640625, 71.38481903076172], [30.690542221069336, -22.79083251953125, 69.51052856445312], [31.346769332885742, -20.987152099609375, 57.410301208496094], [32.69282531738281, -26.804718017578125, 164.48483276367188], [32.62785339355469, -25.300048828125, 93.91680145263672], [32.5911865234375, -24.6279296875, 74.66136169433594], [32.44807052612305, -22.549163818359375, 94.74915313720703], [32.22810363769531, -20.157318115234375, 67.05585479736328], [34.141685485839844, -26.397247314453125, 60.349273681640625], [33.762306213378906, -22.378204345703125, 206.7574005126953], [34.473655700683594, -26.915374755859375, 40.98431396484375], [33.81986618041992, -24.4837646484375, -9999.0], [32.30377197265625, -19.507354736328125, 39.52962112426758], [30.51270866394043, -22.75201416015625, 133.62310791015625], [31.56302261352539, -19.66839599609375, 98.8299331665039], [32.390228271484375, -26.720672607421875, -9999.0], [31.807832717895508, -24.65557861328125, 44.566314697265625], [30.725608825683594, -21.17584228515625, 34.446048736572266], [34.06517028808594, -26.54193115234375, 75.28939819335938], [34.24828338623047, -25.437957763671875, 84.331298828125], [34.62632369995117, -22.886016845703125, 277.0401916503906], [34.81736373901367, -21.402679443359375, 226.14784240722656], [34.90346908569336, -20.67474365234375, 180.2783203125], [33.17257308959961, -26.112030029296875, 36.341102600097656], [32.97958755493164, -24.869781494140625, 49.792694091796875], [32.804649353027344, -23.82421875, 47.560203552246094], [32.65950393676758, -23.0045166015625, 53.86697006225586], [32.61357879638672, -22.752899169921875, 44.7943000793457], [32.460105895996094, -21.93792724609375, 44.810157775878906], [32.368717193603516, -21.469512939453125, 62.33164596557617], [32.27524948120117, -21.002410888671875, -9999.0], [32.18620300292969, -20.567474365234375, 54.087032318115234], [30.393823623657227, -26.054443359375, 251.46656799316406], [31.109737396240234, -23.6832275390625, 88.55705261230469], [31.537012100219727, -22.161651611328125, 98.21757507324219], [32.1295280456543, -21.86865234375, -9999.0], [32.25062561035156, -19.8712158203125, -9999.0], [32.26707077026367, -19.526580810546875, -9999.0], [30.534894943237305, -20.2633056640625, 19.719409942626953], [30.716100692749023, -19.532867431640625, 20.43938636779785], [31.38911247253418, -24.584197998046875, 43.61662673950195], [31.137277603149414, -23.14410400390625, 41.862735748291016], [34.26818084716797, -26.00885009765625, -9999.0], [34.042381286621094, -26.78521728515625, -9999.0], [33.94818878173828, -25.97857666015625, -9999.0], [33.888763427734375, -25.4952392578125, -9999.0], [33.843780517578125, -25.14111328125, 56.234466552734375], [33.78055191040039, -24.6585693359375, -9999.0], [33.71070861816406, -24.14459228515625, -9999.0], [33.51530838012695, -22.798614501953125, 31.26346206665039], [33.44635772705078, -22.35113525390625, 45.24880599975586], [33.40610885620117, -22.095672607421875, -9999.0], [33.29228591918945, -21.394195556640625, 35.80437469482422], [33.18475341796875, -20.757781982421875, 26.13102912902832], [33.112796783447266, -20.344970703125, -9999.0], [32.97599792480469, -19.584503173828125, -9999.0], [33.55417251586914, -26.274169921875, 45.089439392089844], [33.400123596191406, -25.857391357421875, -9999.0], [33.05474853515625, -24.938720703125, 49.45909118652344], [32.749324798583984, -24.14306640625, 52.273170471191406], [32.26519775390625, -22.914031982421875, 50.29221725463867], [31.19342613220215, -20.316802978515625, 41.40702819824219], [30.900007247924805, -19.632415771484375, 42.2154655456543], [32.54754638671875, -26.849029541015625, 158.29986572265625], [33.0604248046875, -25.088348388671875, 114.84428405761719], [33.30351257324219, -24.215545654296875, 140.24423217773438], [33.89173889160156, -21.97955322265625, 277.7386474609375], [34.288719177246094, -20.354095458984375, 164.94741821289062], [30.684852600097656, -25.841796875, 36.64161682128906], [30.57294464111328, -20.468292236328125, 131.5829315185547], [30.635562896728516, -19.947265625, 89.66040802001953], [30.684795379638672, -19.51727294921875, 86.67119598388672], [32.89903259277344, -26.79180908203125, 143.771728515625], [32.69754409790039, -24.5906982421875, 82.86466979980469], [32.505611419677734, -22.872955322265625, 91.5768051147461], [32.4470100402832, -22.39691162109375, 90.29605865478516], [32.16709899902344, -20.340179443359375, 62.034202575683594], [32.912315368652344, -23.914459228515625, 44.969085693359375], [32.431358337402344, -20.365478515625, 39.725379943847656], [33.90314865112305, -26.69671630859375, 35.536865234375], [33.09349060058594, -24.139190673828125, 49.066322326660156], [32.139427185058594, -21.354217529296875, 39.81966018676758], [31.57015037536621, -19.789825439453125, 48.06471252441406], [35.07188034057617, -25.714324951171875, 74.71393585205078], [34.80729293823242, -26.33197021484375, 63.134727478027344], [34.769691467285156, -26.00518798828125, -9999.0], [34.68770980834961, -25.32037353515625, 65.78682708740234], [34.65123748779297, -25.0274658203125, -9999.0], [34.60138702392578, -24.637451171875, 85.47944641113281], [34.56736755371094, -24.37786865234375, -9999.0], [34.52400588989258, -24.053802490234375, 117.80551147460938], [34.28815841674805, -22.40869140625, 336.01800537109375], [34.6896858215332, -26.780548095703125, 44.5697135925293], [34.658447265625, -26.41973876953125, 72.96492004394531], [34.626007080078125, -26.05938720703125, 56.750118255615234], [34.5954704284668, -25.732086181640625, -9999.0], [34.54124069213867, -25.176605224609375, 62.470458984375], [34.44917678833008, -24.296539306640625, 105.42595672607422], [34.39122009277344, -23.77655029296875, 64.1812744140625], [34.34989547729492, -23.419586181640625, -9999.0], [34.27177810668945, -22.771881103515625, -9999.0], [34.19813919067383, -22.1905517578125, 100.4076919555664], [34.09066390991211, -21.385589599609375, -9999.0], [34.01869583129883, -20.8719482421875, 104.7289810180664], [33.857757568359375, -19.784881591796875, -9999.0], [31.52972412109375, -23.952178955078125, 163.84176635742188], [31.962207794189453, -22.572052001953125, 167.42245483398438], [32.66221618652344, -20.197784423828125, 139.5780487060547], [33.38161087036133, -26.40350341796875, 97.58991241455078], [33.23815155029297, -25.23968505859375, 79.03948211669922], [33.090850830078125, -24.14495849609375, 97.8313217163086], [32.78731155395508, -22.128753662109375, 105.06795501708984], [32.66682815551758, -21.397064208984375, 82.09046173095703], [33.58830642700195, -26.959686279296875, 39.01263427734375], [33.401588439941406, -24.213775634765625, 58.28836441040039], [33.01899337768555, -20.41741943359375, 38.89834213256836], [32.97220993041992, -20.03302001953125, 43.85111999511719], [30.715070724487305, -26.867462158203125, 160.0115203857422], [31.7685546875, -23.8563232421875, 76.21337890625], [32.17551040649414, -22.614776611328125, -9999.0], [33.097373962402344, -19.603485107421875, 59.468414306640625], [35.08402633666992, -24.505706787109375, -9999.0], [34.00266647338867, -20.113128662109375, 36.98407745361328], [32.87971878051758, -26.779388427734375, 150.3195037841797], [32.883426666259766, -24.1695556640625, 90.23837280273438], [32.838802337646484, -22.169036865234375, 99.31315612792969], [31.83185386657715, -25.6158447265625, 122.20189666748047], [33.15697479248047, -26.5205078125, 84.10543823242188], [33.61189270019531, -24.389434814453125, 75.74976348876953], [34.00263595581055, -22.36358642578125, 178.95318603515625], [34.27544403076172, -26.352294921875, 53.68450164794922], [34.253021240234375, -25.561126708984375, 55.37291717529297], [34.1308479309082, -22.864990234375, 166.65321350097656], [33.944271087646484, -20.2490234375, 79.96051025390625], [33.15400314331055, -25.054595947265625, 43.2358283996582], [32.88404846191406, -23.919219970703125, 49.83769989013672], [31.764413833618164, -19.698028564453125, 39.621421813964844], [33.88616943359375, -24.4801025390625, 57.02892303466797], [33.60475540161133, -23.271697998046875, 39.98383712768555], [32.739036560058594, -19.886138916015625, 37.379093170166016], [33.3690299987793, -26.751495361328125, 125.46916198730469], [33.8613395690918, -24.478790283203125, 112.35214233398438], [34.267276763916016, -22.400115966796875, 287.9391174316406], [34.57547378540039, -20.65496826171875, 189.7009735107422], [31.947980880737305, -26.940093994140625, 128.38763427734375], [32.3355712890625, -25.25341796875, 98.50328826904297], [32.61201858520508, -23.962554931640625, 93.49590301513672], [32.81078338623047, -22.98101806640625, 100.94412231445312], [33.03636932373047, -21.803680419921875, 105.5274658203125], [33.36370849609375, -19.94598388671875, 75.86082458496094], [31.25441551208496, -26.70330810546875, 142.2064971923828], [31.278667449951172, -22.080535888671875, 65.8697280883789], [33.839622497558594, -24.390289306640625, 56.465938568115234], [32.74456024169922, -19.861328125, 40.916446685791016], [34.15347671508789, -26.835540771484375, -9999.0], [33.967247009277344, -26.43450927734375, -9999.0], [33.82029724121094, -26.1202392578125, -9999.0], [34.5308837890625, -26.95074462890625, 111.76596069335938], [34.62369918823242, -26.50311279296875, 124.83586120605469], [34.74709701538086, -25.893646240234375, 124.26983642578125], [35.0811653137207, -24.149658203125, 144.2081298828125], [33.62663650512695, -26.798919677734375, 42.57345199584961], [33.05769729614258, -25.32171630859375, 57.96345901489258], [32.77956771850586, -24.617950439453125, 50.478328704833984], [32.65082931518555, -24.29656982421875, 52.65590286254883], [32.308128356933594, -23.452667236328125, 49.56313705444336], [31.362884521484375, -21.208404541015625, 48.681373596191406], [30.60093879699707, -19.47894287109375, 47.28887176513672], [34.08358383178711, -26.943572998046875, -9999.0], [34.32445526123047, -26.1317138671875, -9999.0], [34.7308464050293, -24.711395263671875, 799.0278930664062], [32.43374252319336, -25.550323486328125, -9999.0], [34.04433059692383, -26.641876220703125, -9999.0], [33.963809967041016, -26.030181884765625, -9999.0], [33.92448425292969, -25.740692138671875, 42.39974594116211], [33.843467712402344, -25.16241455078125, -9999.0], [33.701576232910156, -24.200469970703125, 48.553443908691406], [33.56126022338867, -23.30511474609375, -9999.0], [33.445716857910156, -22.603271484375, 34.20882797241211], [33.35879135131836, -22.09393310546875, -9999.0], [33.28639221191406, -21.680633544921875, 48.17226028442383], [33.21242904663086, -21.268035888671875, -9999.0], [33.11915588378906, -20.760894775390625, 27.93321990966797], [33.06563949584961, -20.47613525390625, -9999.0], [32.993194580078125, -20.09698486328125, 24.771535873413086], [32.882057189941406, -19.52935791015625, 29.93475341796875], [30.52178192138672, -22.201263427734375, 96.49288177490234], [32.88932418823242, -26.724639892578125, 31.814077377319336], [32.828407287597656, -26.343048095703125, 35.20796585083008], [32.56522750854492, -24.792266845703125, 47.83026123046875], [32.34528732299805, -23.597900390625, 42.29470443725586], [32.09913635253906, -22.34918212890625, 35.42170333862305], [31.970504760742188, -21.728302001953125, 49.633872985839844], [31.898208618164062, -21.3878173828125, 32.609622955322266], [31.791095733642578, -20.893768310546875, -9999.0], [31.6885929107666, -20.432098388671875, -9999.0], [31.61212730407715, -20.09442138671875, 47.47993469238281], [31.541664123535156, -19.788116455078125, 79.24604034423828], [30.695634841918945, -26.82843017578125, 146.62298583984375], [30.83245086669922, -26.37939453125, -9999.0], [30.922698974609375, -26.0792236328125, -9999.0], [31.206357955932617, -25.114166259765625, -9999.0], [31.301950454711914, -24.78082275390625, 50.91716766357422], [31.447784423828125, -24.264190673828125, 71.31075286865234], [31.51561164855957, -24.020416259765625, 59.48463439941406], [31.649658203125, -23.531494140625, 82.8667221069336], [31.959596633911133, -22.364105224609375, 74.50713348388672], [32.180240631103516, -21.498199462890625, 82.43577575683594], [32.394248962402344, -20.62744140625, -9999.0], [32.52828598022461, -20.0653076171875, 70.38218688964844], [30.962047576904297, -24.545867919921875, 40.14118194580078], [30.641305923461914, -22.868621826171875, 42.20601272583008], [32.961883544921875, -26.80609130859375, 85.39894104003906], [34.02385330200195, -22.785980224609375, 218.60781860351562], [33.751556396484375, -24.46490478515625, -9999.0], [33.84053039550781, -24.05426025390625, 277.05206298828125], [34.18817138671875, -22.369171142578125, 210.5499725341797], [35.074100494384766, -22.95977783203125, 306.4860534667969], [35.0372428894043, -21.99737548828125, 245.982666015625], [35.008426666259766, -21.36773681640625, 245.3562774658203], [34.97040557861328, -20.639556884765625, 191.90818786621094], [34.921234130859375, -19.8135986328125, -9999.0], [34.598445892333984, -24.537200927734375, 342.7285461425781], [31.675765991210938, -26.88641357421875, 124.33975982666016], [31.70870018005371, -26.0609130859375, 77.84760284423828], [31.760448455810547, -21.696197509765625, 77.71514129638672], [31.7403507232666, -20.5472412109375, 53.425567626953125], [34.04806137084961, -24.551361083984375, 53.60200119018555], [33.58652877807617, -22.474029541015625, 42.852203369140625], [33.25345993041992, -21.0819091796875, 37.050174713134766], [32.992942810058594, -20.045501708984375, 45.267578125], [31.859683990478516, -26.956573486328125, 87.08785247802734], [32.11450958251953, -25.9332275390625, 59.74224853515625], [32.36693572998047, -24.87237548828125, 71.18221282958984], [32.82073211669922, -22.8267822265625, 106.03563690185547], [33.04933166503906, -21.71636962890625, 123.00348663330078], [33.29653549194336, -20.440032958984375, 88.13615417480469], [34.927154541015625, -26.831512451171875, -9999.0], [34.82097244262695, -26.2520751953125, 45.12873077392578], [34.46542739868164, -24.4251708984375, 50.01097106933594], [34.02473449707031, -22.358184814453125, 40.151824951171875], [33.53982925415039, -20.278594970703125, 39.1561393737793]]


    return render(request, 'toolbox/microplastics.html', {
        'boundary': boundary,
        'wind_speed_heat': wind_spead_data,
        'nbrcs_data': nbrcs_data,
        'peak_list': peak_list,

    })


# API / JSON test call
def get_data(request, *args, **kwargs):
    data = {
        "sales": 100,
        "customers": 10,
    }
    return JsonResponse(data)


class ChartData(APIView):
    authentication_classes = []
    permission_classes = []

    def get(self, request, format=None):
        ssl_lables, levels = collect_sea_levels()
        ssr_lables, roughness = collect_sea_roughness()
        raw_data = raw_measure_info()
        intf_data = interferometric_fringe_info()
        table_data, coordinates, skyplot_data = collect_sat_info()


        data = {
            "ssl_lables": ssl_lables,
            "levels": levels,
            "ssr_lables": ssr_lables,
            "roughness": roughness,
            "raw_data": raw_data,
            "intf_data": intf_data,
            "map_coordinates": coordinates,
            "skyplot_data": skyplot_data
             }
        return Response(data)
